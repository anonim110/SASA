<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackPhonex - Официальный сайт</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #fca5a5; /* Розово-красный (Phoenix fire) */
            --bg-color: #0d0d1a; /* Глубокий тёмно-синий/чёрный */
            --card-color: #1a1a2e;
            font-family: 'Inter', sans-serif;
        }
        body { background-color: var(--bg-color); color: #e5e7eb; }
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--bg-color);
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px -2px rgba(252, 165, 165, 0.5);
            font-weight: 700;
        }
        .btn-primary:hover {
            background-color: #f87171;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px -3px rgba(252, 165, 165, 0.7);
        }
        .input-style {
            background-color: #2c2c43;
            border: 1px solid #4a4a6d;
            color: #ffffff;
            transition: border-color 0.2s;
        }
        .input-style:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) #1f2937;
        }
        .scroll-container::-webkit-scrollbar { width: 8px; }
        .scroll-container::-webkit-scrollbar-track { background: var(--card-color); }
        .scroll-container::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 20px; border: 2px solid var(--card-color); }

        /* Стили для модального окна */
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Загрузка Firebase SDKs и логика приложения -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Глобальные переменные, предоставленные средой Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // *** ХАРДКОД КЛЮЧ АДМИНИСТРАТОРА ***
        // Установлен по запросу пользователя. Для входа используйте: admin2025
        const HARDCODED_ADMIN_KEY = "admin2025";
        // **********************************

        let db, auth, currentUserId;
        let isAdmin = false;

        setLogLevel('Debug');

        // Инициализация Firebase
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase Initialization Failed (Environment Config Issue):", e);
            document.getElementById('firebase-status').textContent = "Ошибка инициализации Firebase. Проверьте конфигурацию среды.";
        }

        // UI-элементы
        const albumsList = document.getElementById('albums-list');
        const songsList = document.getElementById('songs-list');
        const songPlayer = document.getElementById('song-player');
        const playerTitle = document.getElementById('player-title');
        const userIdDisplay = document.getElementById('user-id-display');
        const adminUploadContent = document.getElementById('admin-upload-content');
        const albumSelect = document.getElementById('song-album-id');
        const uploadSection = document.getElementById('upload-section');
        
        // Элементы Модального окна
        const adminModal = document.getElementById('admin-modal');
        const openAdminBtn = document.getElementById('open-admin-modal-btn');
        const closeAdminBtn = document.getElementById('close-admin-modal-btn');


        // Пути к коллекциям (публичные данные)
        const ALBUMS_COLLECTION = `artifacts/${appId}/public/data/albums`;
        const SONGS_COLLECTION = `artifacts/${appId}/public/data/songs`;

        // --- 1. АУТЕНТИФИКАЦИЯ И ИНИЦИАЛИЗАЦИЯ ---
        async function authenticateUser() {
            if (!auth) return;
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Ошибка аутентификации:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = `Ваш ID: ${currentUserId.substring(0, 8)}...`;
                
                listenToAlbums();
                listenToSongs();
            } else {
                currentUserId = null;
                userIdDisplay.textContent = 'Анонимный вход';
            }
        });

        authenticateUser();

        // --- 2. АДМИН АУТЕНТИФИКАЦИЯ (ПРОВЕРКА ХАРДКОД КЛЮЧА) ---

        // Логика Модального окна
        openAdminBtn.addEventListener('click', () => {
            adminModal.classList.remove('hidden');
        });

        closeAdminBtn.addEventListener('click', () => {
            adminModal.classList.add('hidden');
        });
        
        // Обработка отправки формы в модальном окне
        document.getElementById('admin-key-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const key = document.getElementById('admin-key-input').value.trim();
            checkAdminKey(key);
            document.getElementById('admin-key-input').value = ''; // Очистка поля
        });

        async function checkAdminKey(inputKey) {
            // Проверка введенного ключа с жестко заданным ключом
            if (inputKey === HARDCODED_ADMIN_KEY) {
                isAdmin = true;
                adminModal.classList.add('hidden'); // Закрываем модальное окно
                adminUploadContent.classList.remove('hidden');
                openAdminBtn.classList.add('hidden'); // Скрываем кнопку входа
                uploadSection.classList.remove('hidden');
                alertMessage("Вход администратора успешен! Вы можете добавлять ссылки.", 'success');
            } else {
                alertMessage("Неверный административный ключ.", 'error');
                isAdmin = false;
            }
        }


        // --- 3. УПРАВЛЕНИЕ АЛЬБОМАМИ ---

        document.getElementById('album-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin || !db) {
                alertMessage("Доступ запрещен. Войдите как администратор.", 'error');
                return;
            }
            const name = document.getElementById('album-name').value.trim();
            const description = document.getElementById('album-description').value.trim();
            if (!name || !currentUserId) return;

            try {
                await addDoc(collection(db, ALBUMS_COLLECTION), {
                    name: name,
                    description: description,
                    creatorId: currentUserId,
                    timestamp: serverTimestamp()
                });
                alertMessage(`Альбом "${name}" успешно создан!`, 'success');
                e.target.reset();
            } catch (e) {
                console.error("Ошибка при добавлении альбома:", e);
                alertMessage("Ошибка при добавлении альбома.", 'error');
            }
        });

        function listenToAlbums() {
            if (!db) return;
            const q = query(collection(db, ALBUMS_COLLECTION));
            onSnapshot(q, (snapshot) => {
                const albums = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAlbums(albums);
                updateAlbumSelect(albums);
            }, (error) => {
                console.error("Ошибка при получении альбомов:", error);
            });
        }

        function renderAlbums(albums) {
            albumsList.innerHTML = '';
            if (albums.length === 0) {
                albumsList.innerHTML = '<p class="text-gray-400 p-4 col-span-full">Пока нет альбомов. Создайте первый.</p>';
                return;
            }
            albums.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            albums.forEach(album => {
                const albumEl = document.createElement('div');
                albumEl.className = 'p-4 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition duration-150 shadow-lg border border-red-900/50';
                albumEl.dataset.albumId = album.id;
                albumEl.innerHTML = `
                    <h3 class="text-lg font-semibold text-red-300 truncate">${album.name}</h3>
                    <p class="text-sm text-gray-400 truncate mt-1">${album.description || 'Нет описания'}</p>
                    <p class="text-xs text-gray-500 mt-2">ID: ${album.creatorId.substring(0, 4)}...</p>
                `;
                albumsList.appendChild(albumEl);
            });
        }

        function updateAlbumSelect(albums) {
            albumSelect.innerHTML = '<option value="">-- Выберите альбом --</option>';
            albums.forEach(album => {
                const option = document.createElement('option');
                option.value = album.id;
                option.textContent = album.name;
                albumSelect.appendChild(option);
            });
        }

        // --- 4. УПРАВЛЕНИЕ ПЕСНЯМИ (ДОБАВЛЕНИЕ ССЫЛКИ И ВОСПРОИЗВЕДЕНИЕ) ---
        
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin || !db) {
                alertMessage("Доступ запрещен.", 'error');
                return;
            }
            
            const title = document.getElementById('song-title').value.trim();
            const artist = document.getElementById('song-artist').value.trim();
            const albumId = document.getElementById('song-album-id').value;
            const audioUrl = document.getElementById('audio-url-input').value.trim(); 

            if (!title || !artist || !albumId || !audioUrl) {
                alertMessage("Пожалуйста, заполните все поля и укажите прямую ссылку на аудиофайл.", 'warning');
                return;
            }
            
            try {
                await addDoc(collection(db, SONGS_COLLECTION), {
                    title: title,
                    artist: artist,
                    albumId: albumId,
                    creatorId: currentUserId,
                    audioUrl: audioUrl, 
                    duration: 'N/A', 
                    timestamp: serverTimestamp()
                });
                
                alertMessage(`Песня "${title}" успешно добавлена по ссылке!`, 'success');
                e.target.reset();
            } catch (e) {
                console.error("Ошибка при добавлении песни:", e);
                alertMessage(`Ошибка: ${e.message}`, 'error');
            }
        });


        function listenToSongs() {
            if (!db) return;
            const q = query(collection(db, SONGS_COLLECTION));
            onSnapshot(q, (snapshot) => {
                const songs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSongs(songs);
            }, (error) => {
                console.error("Ошибка при получении песен:", error);
            });
        }

        function renderSongs(songs) {
            songsList.innerHTML = '';
            if (songs.length === 0) {
                songsList.innerHTML = '<p class="text-gray-400 p-4">В плейлисте пока нет песен.</p>';
                return;
            }
            songs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            songs.forEach(song => {
                const songEl = document.createElement('div');
                songEl.className = 'flex items-center justify-between p-3 bg-gray-900/70 rounded-lg shadow-md hover:bg-gray-800 transition duration-150 border-l-4 border-red-500';
                songEl.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <p class="text-lg font-medium text-white truncate">${song.title}</p>
                        <p class="text-sm text-gray-400">${song.artist} <span class="text-gray-500">(${song.duration})</span></p>
                    </div>
                    <button class="play-btn ml-4 p-2 rounded-full btn-primary flex-shrink-0" data-url="${song.audioUrl}" data-title="${song.title} - ${song.artist}" aria-label="Play ${song.title}">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                    </button>
                `;
                songsList.appendChild(songEl);
            });
            attachPlayListeners();
        }

        function attachPlayListeners() {
            document.querySelectorAll('.play-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const url = e.currentTarget.dataset.url;
                    const title = e.currentTarget.dataset.title;
                    playSong(url, title);
                });
            });
        }

        function playSong(url, title) {
            songPlayer.pause(); 
            songPlayer.src = url;
            playerTitle.textContent = `Сейчас играет: ${title}`;
            songPlayer.controls = true; 
            
            songPlayer.load(); 
            songPlayer.play().catch(error => {
                console.error("Ошибка воспроизведения. Убедитесь, что это прямая ссылка на аудиофайл.", error);
                alertMessage("Воспроизведение заблокировано браузером, или ссылка не является прямой ссылкой на аудио. Нажмите Play вручную.", 'error');
            });
        }

        // --- 5. УВЕДОМЛЕНИЯ (ВМЕСТО ALERT) ---
        function alertMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.className = 'fixed top-4 right-4 p-4 rounded-xl shadow-2xl z-50 transition-transform duration-300 ease-out transform translate-x-0 opacity-100';
            messageBox.textContent = message;
            
            if (type === 'success') {
                messageBox.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600', 'text-white');
            } else if (type === 'warning') {
                 messageBox.classList.add('bg-yellow-500', 'text-gray-900');
            } else {
                messageBox.classList.add('bg-blue-500', 'text-white');
            }

            setTimeout(() => {
                messageBox.classList.replace('translate-x-0', 'translate-x-full');
                messageBox.classList.replace('opacity-100', 'opacity-0');
            }, 4000);
            setTimeout(() => {
                 messageBox.className = 'hidden';
            }, 4300);
        }

    </script>

    <!-- UI: Основной макет -->
    <header class="bg-gray-900 shadow-xl p-4 sticky top-0 z-20">
        <div class="max-w-7xl mx-auto flex flex-wrap justify-between items-center">
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-wider text-red-400">BLACKPHONEX <span class="text-sm text-gray-500 ml-2 block sm:inline-block">OFFICIAL</span></h1>
            <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                <button id="open-admin-modal-btn" class="btn-primary p-2 px-4 rounded-full text-sm font-semibold hover:ring-2 hover:ring-red-400">
                    Вход для Админа
                </button>
                <p id="user-id-display" class="text-xs text-gray-400 bg-gray-800 p-2 rounded-full px-4 flex-shrink-0">
                    Загрузка...
                </p>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full p-4 space-y-8 lg:grid lg:grid-cols-3 lg:gap-8 lg:space-y-0">
        
        <!-- Колонка 1: Управление и Загрузка (lg:col-span-1) -->
        <div id="upload-section" class="lg:col-span-1 space-y-8">
            <!-- КОНТЕНТ АДМИНА (Скрыт по умолчанию) -->
            <div id="admin-upload-content" class="space-y-6 hidden">
                <div class="bg-card-color p-6 rounded-xl shadow-2xl border-t-4 border-red-500">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Создать Альбом</h2>
                    <form id="album-form" class="space-y-4">
                        <div>
                            <label for="album-name" class="block text-sm font-medium text-gray-300">Название Альбома</label>
                            <input type="text" id="album-name" required class="mt-1 block w-full input-style p-3 rounded-lg">
                        </div>
                        <div>
                            <label for="album-description" class="block text-sm font-medium text-gray-300">Описание</label>
                            <textarea id="album-description" class="mt-1 block w-full input-style p-3 rounded-lg" rows="2"></textarea>
                        </div>
                        <button type="submit" class="w-full btn-primary p-3 rounded-lg font-bold">
                            Создать
                        </button>
                    </form>
                </div>

                <div class="bg-card-color p-6 rounded-xl shadow-2xl border-t-4 border-red-500">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Добавить Песню по ссылке</h2>
                    <form id="upload-form" class="space-y-4">
                        <div>
                            <label for="song-title" class="block text-sm font-medium text-gray-300">Название Песни</label>
                            <input type="text" id="song-title" required class="mt-1 block w-full input-style p-3 rounded-lg">
                        </div>
                        <div>
                            <label for="song-artist" class="block text-sm font-medium text-gray-300">Исполнитель</label>
                            <input type="text" id="song-artist" required class="mt-1 block w-full input-style p-3 rounded-lg">
                        </div>
                        <div>
                            <label for="song-album-id" class="block text-sm font-medium text-gray-300">Выбрать Альбом</label>
                            <select id="song-album-id" required class="mt-1 block w-full input-style p-3 rounded-lg appearance-none">
                                <option value="">-- Выберите альбом --</option>
                            </select>
                        </div>
                        <div>
                            <label for="audio-url-input" class="block text-sm font-medium text-red-300">Прямая ссылка на аудиофайл (Audio URL)</label>
                            <input type="url" id="audio-url-input" placeholder="https://example.com/audio/song.mp3" required class="mt-1 block w-full input-style p-3 rounded-lg" pattern="https?://.*">
                            <p class="text-xs text-gray-500 mt-1">Используйте прямую ссылку на файл (.mp3, .wav и т.д.), размещенный на бесплатном хостинге.</p>
                        </div>
                        <button type="submit" class="w-full btn-primary p-3 rounded-lg font-bold">
                            Добавить в Плейлист
                        </button>
                    </form>
                </div>
            </div>
            <!-- КОНЕЦ КОНТЕНТА АДМИНА -->

        </div>

        <!-- Колонка 2: Списки Альбомов и Песен (lg:col-span-2) -->
        <div class="lg:col-span-2 space-y-8">
            
            <!-- Список Альбомов -->
            <div class="bg-card-color p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 text-white">Популярные Альбомы</h2>
                <div id="albums-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 h-64 overflow-y-auto scroll-container p-2 -m-2">
                    <p class="text-gray-400 col-span-full">Загрузка альбомов...</p>
                </div>
            </div>

            <!-- Список Песен -->
            <div class="bg-card-color p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 text-white">Плейлист BlackPhonex</h2>
                <div id="songs-list" class="space-y-3 h-[40vh] md:h-96 overflow-y-auto scroll-container p-2 -m-2">
                    <p class="text-gray-400">Загрузка песен...</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Модальное окно для входа Администратора -->
    <div id="admin-modal" class="fixed inset-0 modal-bg flex items-center justify-center p-4 hidden z-50">
        <div class="bg-card-color p-8 rounded-xl shadow-2xl w-full max-w-md border-t-4 border-red-500 relative">
            <button id="close-admin-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-red-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-semibold mb-6 text-white text-center">Вход Администратора</h2>
            <form id="admin-key-form" class="space-y-4">
                <div>
                    <label for="admin-key-input" class="block text-sm font-medium text-gray-300">Секретный ключ</label>
                    <input type="password" id="admin-key-input" required class="mt-1 block w-full input-style p-3 rounded-lg">
                </div>
                <button type="submit" class="w-full btn-primary p-3 rounded-lg font-bold">
                    Войти
                </button>
                <p class="text-xs text-center text-gray-500 mt-2">
                    Секретный ключ для входа: <span class="text-red-300 font-bold">admin2025</span> (установлен прямо в коде).
                </p>
            </form>
        </div>
    </div>

    <!-- Footer: Аудиоплеер -->
    <footer class="bg-gray-900 sticky bottom-0 border-t border-gray-700 z-30">
        <div id="song-player-container" class="max-w-7xl mx-auto p-4 flex flex-col md:flex-row justify-between items-center space-y-3 md:space-y-0">
            <div class="w-full md:w-auto">
                <p id="player-title" class="text-red-300 font-bold text-sm md:text-lg text-center md:text-left">
                    Сейчас играет: Ничего
                </p>
            </div>
            <!-- Атрибут controls добавляется при вызове playSong() -->
            <audio id="song-player" class="w-full md:w-3/5 lg:w-1/2 rounded-full" src=""></audio>
        </div>
    </footer>

    <!-- Всплывающее уведомление -->
    <div id="message-box" class="hidden"></div>
    <div id="firebase-status" class="hidden"></div>

</body>
</html>
