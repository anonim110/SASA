<!DOCTYPE html>
<html>
<head>
    <title>NEON LITE</title>
    <style>
        body { margin: 0; background: #0a0a0a; overflow: hidden; font-family: sans-serif; cursor: crosshair; }
        canvas { display: block; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; pointer-events: none; }
        .bar { width: 200px; height: 15px; background: #333; margin-bottom: 5px; border: 1px solid #fff; }
        .fill { height: 100%; transition: width 0.1s; }
        #hp-fill { background: #f04; }
        #stamina-fill { background: #0cf; }
        #w-info { margin-top: 10px; color: #aaa; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="bar"><div id="hp-fill" class="fill" style="width:100%"></div></div>
        <div class="bar"><div id="stamina-fill" class="fill" style="width:100%"></div></div>
        <div id="w-info">1: Rifle | 2: Shotgun | 3: Sniper</div>
    </div>
    <canvas id="game"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let me = { id: null };
        let players = {};
        let bullets = [];
        let orbs = [];
        let obstacles = [];
        let mapSize = 2000;
        let cam = { x: 0, y: 0 };

        let keys = { w: false, a: false, s: false, d: false, dash: false };
        let mouse = { x: 0, y: 0 };

        socket.on('init', (data) => {
            obstacles = data.obstacles;
            mapSize = data.mapSize;
            me.id = data.myId;
        });

        // Управление
        window.addEventListener('keydown', e => {
            if(e.key === 'w') keys.w = true;
            if(e.key === 'a') keys.a = true;
            if(e.key === 's') keys.s = true;
            if(e.key === 'd') keys.d = true;
            if(e.code === 'Space') keys.dash = true;
            if(['1','2','3'].includes(e.key)) socket.emit('changeWeapon', e.key);
        });

        window.addEventListener('keyup', e => {
            if(e.key === 'w') keys.w = false;
            if(e.key === 'a') keys.a = false;
            if(e.key === 's') keys.s = false;
            if(e.key === 'd') keys.d = false;
            if(e.code === 'Space') keys.dash = false;
        });

        window.addEventListener('mousemove', e => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });

        window.addEventListener('mousedown', () => socket.emit('shoot'));

        // Отправка данных
        setInterval(() => {
            if (!me.id) return;
            const angle = Math.atan2(mouse.y - canvas.height/2, mouse.x - canvas.width/2);
            socket.emit('input', { ...keys, angle });
        }, 1000 / 60);

        // Отрисовка
        socket.on('state', (state) => {
            players = state.players;
            bullets = state.bullets;
            orbs = state.orbs;

            const myPlayer = players[me.id];
            if (myPlayer) {
                cam.x = canvas.width/2 - myPlayer.x;
                cam.y = canvas.height/2 - myPlayer.y;
                document.getElementById('hp-fill').style.width = myPlayer.hp + '%';
                document.getElementById('stamina-fill').style.width = myPlayer.stamina + '%';
            }

            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(cam.x, cam.y);

            // Карта
            ctx.strokeStyle = '#333';
            ctx.strokeRect(0,0,mapSize,mapSize);
            
            // Аптечки
            ctx.fillStyle = '#0f0';
            for(let o of orbs) { ctx.beginPath(); ctx.arc(o.x, o.y, 8, 0, 7); ctx.fill(); }

            // Стены
            ctx.fillStyle = '#222'; ctx.strokeStyle = '#555';
            for(let o of obstacles) { ctx.fillRect(o.x, o.y, o.w, o.h); ctx.strokeRect(o.x, o.y, o.w, o.h); }

            // Пули
            ctx.fillStyle = '#ff0';
            for(let b of bullets) { ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, 7); ctx.fill(); }

            // Игроки
            for(let id in players) {
                let p = players[id];
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.angle);
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(0,0,20,0,7); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.fillRect(10, -5, 25, 10); // Оружие
                ctx.restore();
            }
            ctx.restore();
        });
    </script>
</body>
</html>
