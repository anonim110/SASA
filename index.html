<!DOCTYPE html>
<html>
<head>
    <title>NEON PRO</title>
    <style>
        body { margin: 0; background: #0a0a0a; overflow: hidden; font-family: 'Arial Black', sans-serif; cursor: crosshair; }
        canvas { display: block; }
        
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        
        #hud { position: absolute; bottom: 20px; left: 20px; color: white; text-shadow: 0 0 5px rgba(0,0,0,0.8); }
        .bar-wrap { width: 250px; height: 15px; background: #333; border: 2px solid #555; margin-bottom: 5px; transform: skewX(-10deg); }
        .bar-fill { height: 100%; transition: width 0.1s; }
        #hp-fill { background: #ff0044; width: 100%; box-shadow: 0 0 10px #ff0044; }
        #stamina-fill { background: #00ccff; width: 100%; box-shadow: 0 0 10px #00ccff; }
        
        #weapons { margin-top: 10px; display: flex; gap: 10px; }
        .w-icon { padding: 5px 10px; background: rgba(0,0,0,0.5); border: 1px solid #444; color: #888; }
        .w-active { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }

        #killfeed { position: absolute; top: 20px; right: 20px; text-align: right; color: #ffcc00; font-size: 14px; text-shadow: 0 0 2px black; }
        
        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; pointer-events: auto; flex-direction: column;}
        #start-btn { padding: 20px 50px; font-size: 24px; background: #ff0044; color: white; border: none; cursor: pointer; border: 4px solid white; box-shadow: 0 0 20px #ff0044; font-family: 'Arial Black'; }
        #start-btn:hover { transform: scale(1.1); }
        
        .help { color: #aaa; margin-top: 20px; font-size: 14px; text-align: center; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="killfeed"></div>
        <div id="hud">
            <div class="bar-wrap"><div id="hp-fill" class="bar-fill"></div></div>
            <div class="bar-wrap"><div id="stamina-fill" class="bar-fill"></div></div>
            <div id="weapons">
                <div id="w1" class="w-icon w-active">1. RIFLE</div>
                <div id="w2" class="w-icon">2. SHOTGUN</div>
                <div id="w3" class="w-icon">3. SNIPER</div>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <button id="start-btn">CLICK TO PLAY</button>
        <div class="help">
            WASD = Move<br>SPACE = Dash<br>CLICK = Shoot<br>1, 2, 3 = Change Weapon<br>ESC = Unlock Cursor
        </div>
    </div>

    <canvas id="game"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- STATE ---
        let me = { id: null, x: 0, y: 0, hp: 100, stamina: 100 };
        let obstacles = [];
        let orbs = [];
        let mapSize = 2000;
        
        let keys = { w: false, a: false, s: false, d: false, dash: false };
        let mouse = { x: canvas.width/2, y: canvas.height/2 }; // Virtual mouse pos
        let cam = { x: 0, y: 0 };
        let particles = [];
        let shake = 0;

        // --- POINTER LOCK & INPUT ---
        const startBtn = document.getElementById('start-btn');
        const startScreen = document.getElementById('start-screen');

        startBtn.addEventListener('click', () => {
            canvas.requestPointerLock();
        });

        document.addEventListener('pointerlockchange', () => {
            if (document.pointerLockElement === canvas) {
                startScreen.style.display = 'none';
            } else {
                startScreen.style.display = 'flex';
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement === canvas) {
                // Ð”Ð²Ð¸Ð³Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ñ†ÐµÐ»
                mouse.x += e.movementX;
                mouse.y += e.movementY;
                
                // ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ñ†ÐµÐ» ÑÐºÑ€Ð°Ð½Ð¾Ð¼ (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÑƒÐ»ÐµÑ‚Ð°Ð» Ð´Ð°Ð»ÐµÐºÐ¾)
                mouse.x = Math.max(0, Math.min(canvas.width, mouse.x));
                mouse.y = Math.max(0, Math.min(canvas.height, mouse.y));
            }
        });

        window.addEventListener('mousedown', () => {
            if(document.pointerLockElement === canvas) socket.emit('shoot');
        });

        window.addEventListener('keydown', e => {
            if(e.key === 'w') keys.w = true;
            if(e.key === 'a') keys.a = true;
            if(e.key === 's') keys.s = true;
            if(e.key === 'd') keys.d = true;
            if(e.code === 'Space') keys.dash = true;
            
            if(e.key === '1') { socket.emit('changeWeapon', 1); updateWeaponUI(1); }
            if(e.key === '2') { socket.emit('changeWeapon', 2); updateWeaponUI(2); }
            if(e.key === '3') { socket.emit('changeWeapon', 3); updateWeaponUI(3); }
        });
        
        window.addEventListener('keyup', e => {
            if(e.key === 'w') keys.w = false;
            if(e.key === 'a') keys.a = false;
            if(e.key === 's') keys.s = false;
            if(e.key === 'd') keys.d = false;
            if(e.code === 'Space') keys.dash = false;
        });

        function updateWeaponUI(num) {
            document.querySelectorAll('.w-icon').forEach(el => el.classList.remove('w-active'));
            document.getElementById('w'+num).classList.add('w-active');
        }

        // --- NETWORKING ---
        socket.on('init', (data) => {
            obstacles = data.obstacles;
            mapSize = data.mapSize;
            me.id = data.myId;
        });

        // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
        setInterval(() => {
            if (!me.id) return;
            // Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÑƒÐ³Ð¾Ð» Ð¾Ñ‚ Ð¦Ð•ÐÐ¢Ð Ð ÑÐºÑ€Ð°Ð½Ð° (Ð³Ð´Ðµ Ð¸Ð³Ñ€Ð¾Ðº) Ðº ÐºÑƒÑ€ÑÐ¾Ñ€Ñƒ Ð¼Ñ‹ÑˆÐ¸
            const angle = Math.atan2(mouse.y - canvas.height/2, mouse.x - canvas.width/2);
            socket.emit('input', { ...keys, angle });
        }, 1000 / 60);

        // Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ„Ñ„ÐµÐºÑ‚Ñ‹ (Ð—Ð²ÑƒÐº/ÐšÑ€Ð¾Ð²ÑŒ)
        socket.on('hit', (pos) => {
            for(let i=0; i<5; i++) createParticle(pos.x, pos.y, 'red');
        });

        socket.on('sound', (data) => {
            if (data.type === 'shoot') {
                // Ð•ÑÐ»Ð¸ ÑÑ‚Ñ€ÐµÐ»ÑÐ» Ñ - Ñ‚Ñ€ÑÑÐµÐ¼ ÑÐºÑ€Ð°Ð½
                const p = playersCache[socket.id]; // (defined below in loop)
                if (data.wpn === 3) shake = 10; // Ð¡Ð½Ð°Ð¹Ð¿ÐµÑ€ÐºÐ° Ñ‚Ñ€ÑÑÐµÑ‚ ÑÐ¸Ð»ÑŒÐ½Ð¾
                else shake = 2;
            }
        });
        
        socket.on('killFeed', (data) => {
            const feed = document.getElementById('killfeed');
            const msg = document.createElement('div');
            msg.innerText = `${data.killer} ðŸ’€ ${data.victim}`;
            feed.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        });

        let playersCache = {};

        // --- RENDER LOOP ---
        socket.on('state', (state) => {
            playersCache = state.players;
            const myPlayer = state.players[me.id];
            
            // ÐŸÐ»Ð°Ð²Ð½Ð°Ñ ÐºÐ°Ð¼ÐµÑ€Ð° (Lerp)
            if (myPlayer) {
                let targetX = myPlayer.x - canvas.width/2;
                let targetY = myPlayer.y - canvas.height/2;
                cam.x += (targetX - cam.x) * 0.1;
                cam.y += (targetY - cam.y) * 0.1;
                
                // UI Update
                document.getElementById('hp-fill').style.width = myPlayer.hp + '%';
                document.getElementById('stamina-fill').style.width = myPlayer.stamina + '%';
            }

            // ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ñ‚Ñ€ÑÑÐºÑƒ
            let shakeX = (Math.random() - 0.5) * shake;
            let shakeY = (Math.random() - 0.5) * shake;
            if(shake > 0) shake *= 0.9;

            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-cam.x + shakeX, -cam.y + shakeY);

            // Ð“Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ ÐºÐ°Ñ€Ñ‚Ñ‹
            ctx.strokeStyle = '#333';
            ctx.strokeRect(0, 0, mapSize, mapSize);

            // Ð¡ÐµÑ‚ÐºÐ°
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for(let x=0; x<=mapSize; x+=100) { ctx.moveTo(x,0); ctx.lineTo(x,mapSize); }
            for(let y=0; y<=mapSize; y+=100) { ctx.moveTo(0,y); ctx.lineTo(mapSize,y); }
            ctx.stroke();

            // ÐÐ¿Ñ‚ÐµÑ‡ÐºÐ¸
            for(let o of state.orbs) {
                ctx.fillStyle = '#0f0';
                ctx.shadowBlur = 15; ctx.shadowColor = '#0f0';
                ctx.beginPath(); ctx.arc(o.x, o.y, 10, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            }

            // Ð¡Ñ‚ÐµÐ½Ñ‹
            ctx.fillStyle = '#111';
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 4;
            for(let o of obstacles) {
                ctx.fillRect(o.x, o.y, o.w, o.h);
                ctx.strokeRect(o.x, o.y, o.w, o.h);
            }

            // Ð§Ð°ÑÑ‚Ð¸Ñ†Ñ‹
            updateParticles();

            // ÐŸÑƒÐ»Ð¸
            for (let b of state.bullets) {
                ctx.fillStyle = '#ffff00';
                ctx.shadowBlur = 10; ctx.shadowColor = '#ffff00';
                ctx.beginPath();
                ctx.arc(b.x, b.y, 4, 0, Math.PI*2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            // Ð˜Ð³Ñ€Ð¾ÐºÐ¸
            for (let id in state.players) {
                const p = state.players[id];
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.angle);

                // Ð ÑƒÐºÐ¸/ÐžÑ€ÑƒÐ¶Ð¸Ðµ
                ctx.fillStyle = '#888';
                if (p.weapon === 1) ctx.fillRect(10, -5, 30, 10); // Rifle
                if (p.weapon === 2) ctx.fillRect(10, -5, 20, 15); // Shotgun
                if (p.weapon === 3) ctx.fillRect(10, -3, 50, 6);  // Sniper

                // Ð¢ÐµÐ»Ð¾
                ctx.fillStyle = p.color;
                ctx.shadowBlur = 10; ctx.shadowColor = p.color;
                ctx.beginPath(); ctx.arc(0, 0, 22, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;

                // Ð˜Ð¼Ñ
                ctx.restore();
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(p.username, p.x, p.y - 35);
            }

            ctx.restore();

            // --- DRAW CURSOR (Crosshair) ---
            if (document.pointerLockElement === canvas) {
                ctx.strokeStyle = '#0f0';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(mouse.x, mouse.y, 10, 0, Math.PI*2);
                ctx.moveTo(mouse.x - 15, mouse.y); ctx.lineTo(mouse.x + 15, mouse.y);
                ctx.moveTo(mouse.x, mouse.y - 15); ctx.lineTo(mouse.x, mouse.y + 15);
                ctx.stroke();
            }
        });

        // Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ñ‡Ð°ÑÑ‚Ð¸Ñ†
        function createParticle(x, y, color) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 5,
                vy: (Math.random() - 0.5) * 5,
                life: 20,
                color: color
            });
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / 20;
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }
    </script>
</body>
</html>
